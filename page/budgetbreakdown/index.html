<!--<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>The flow of Fairfax county money from revenue to expenditure</title>
</head>
<body>
    We need a "Sankey Diagram" like this:
    <a href="http://bl.ocks.org/saraquigley/raw/5194141/">Imagine this is Fairfax budget money, not UC Berkley Student problems...the data has the same form</a>
</body>
</html>-->

<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Fairfax County Budget Breakdowns</title>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="../../lib/sankey.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.js"></script>

    <style type="text/css">
        html {
            min-width: 1040px;
        }

        body {
            background: #fcfcfa;
            font-family: Helvetica, Arial, sans-serif;
            margin: 1em auto 2em 1em;
            position: relative;
            width: 1100px;
        }

        header,
        footer {
            color: #000;
            font-family: "PT Sans", sans-serif;
        }


        footer {
            font-size: small;
            margin-top: 8em;
        }


        a {
            color: steelblue;
        }

        svg {
            font: 500 14px "arial", sans-serif;
            fill: #023858;
        }


        #chart {
            height: 700px;
        }

        .columnHead {
            font-family: Helvetica, Arial, sans-serif;
        }


        .node rect {
            cursor: move;
            fill-opacity: .75;
            shape-rendering: crispEdges;
        }

        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
        }

        .link {
            fill: none;
            stroke: #969696;
            stroke-opacity: .2;
        }

            .link:hover {
                stroke-opacity: .5;
            }

        .lookingAtMyAccount {
            fill: #1f77b4;
            color: #1f77b4;
            position: absolute;
            width: 200px;
        }


        .whatsHappening {
            fill: #bd9e39;
            color: #bd9e39;
            left: 200px;
            position: absolute;
            width: 200px;
        }

        .whatsProblematic {
            fill: #ad494a;
            color: #ad494a;
            left: 400px;
            position: absolute;
            width: 200px;
        }

        .proposedRemediation {
            fill: #637939;
            color: #637939;
            left: 690px;
            position: absolute;
            width: 200px;
        }

        .businessProcess {
            fill: #ce6dbd;
        }

        .uiDesign {
            fill: #a55194;
            font: 400 18px "Helvetica Neue";
        }

        .sysInfrastructure {
            fill: #de9ed6;
            font: 400 18px "Helvetica Neue";
        }

        .ProcessDesignTech {
            left: 1050px;
            position: absolute;
            width: 350px;
            font: 400 20px "Helvetica Neue";
        }
    </style>
</head>
<body>


    <header>
        <b>Fairfax County Public Schools FY 2016 Approved Budget</b>
        <br>Funding sources and uses
        <p>
    </header>

    <div class="columnHead">
        <span class="lookingAtMyAccount">Funding Sources</span>
        <span class="whatsHappening">Total Budget</span>
        <span class="whatsProblematic">Instruction & Operations</span>
        <span class="proposedRemediation">Uses</span>
        <!--<span class="ProcessDesignTech">
           
            <br>
            <font color="#a55194">Design</font><font color="#7f7f7f"> | </font>
            <font color="#ce6dbd">Process</font><font color="#7f7f7f"> | </font>
            <font color="#de9ed6">Tech</font>
        </span>-->
    </div>
    <p id="chart">
        
        <script>
            var pct = d3.format(",.1%");

            var margin = {
                top: 50, right: 30, bottom: 6, left: 1
            },

            width = 900 - margin.left - margin.right,
            height = 700 - margin.top - margin.bottom;

            var category20b_sq = ['#393b79', '#5254a3', '#6b6ecf', '#9c9ede', '#8c6d31', '#bd9e39', '#e7ba52', '#e7cb94',
            '#843c39', '#ad494a', '#d6616b', '#e7969c', '#637939', '#8ca252', '#b5cf6b', '#cedb9c',
            '#ce6dbd', '#a55194', '#de9ed6', '#7b4173'];

            var formatNumber = d3.format(",.0f"),
            format = function (d) {
                return formatNumber(d);
            },

            color = d3.scale.ordinal().range(category20b_sq);
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var sankey = d3.sankey()
                .nodeWidth(20)
                .nodePadding(35)
                .size([width - 150, height]);

            var path = sankey.link();

            d3.json("budget.json", function (budget) {
                
                sankey
                    .nodes(budget.nodes)
                    .links(budget.links)
                    .layout(50);

                var link = svg.append("g").selectAll(".link")
                    .data(budget.links)
                  .enter().append("path")
                    .attr("class", "link")
                    .attr("d", path)
                    .style("stroke-width", function (d) { return Math.max(1, d.dy); })
                    .sort(function (a, b) { return b.dy - a.dy; });

                link.append("title")
                    .text(function (d) { return d.source.name + " → " + d.target.name; });

                var node = svg.append("g").selectAll(".node")
                    .data(budget.nodes)
                  .enter().append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) { return "translate(" + d.x + "," + d.y + ")"; })
                  .call(d3.behavior.drag()
                    .origin(function (d) { return d; })
                    .on("dragstart", function () { this.parentNode.appendChild(this); })
                    .on("drag", dragmove));

                node.append("rect")
                    .attr("height", function (d) { return d.dy; })
                    .attr("width", sankey.nodeWidth())
                    .style("fill", function (d) { return color(d.category); })
                  .append("title")
                    .text(function (d) { return d.name; });

                node.append("text")
                    .attr("x", 6 + sankey.nodeWidth())
                    .attr("y", function (d) { return (d.dy / 2) - 10; })
                    .attr("dy", ".35em")
                    .attr("text-anchor", "start")
                    .attr("transform", null)
                    .text(function (d) {
                        return d.name;
                    });

                node.append("text")
                    .attr("x", 6 + sankey.nodeWidth())
                    .attr("y", function (d) { return (d.dy / 2) + 10; })
                    .attr("dy", ".25em")
                    .attr("text-anchor", "start")
                    .attr("transform", null)
                    .text(function (d) {
                        if (d.amount)
                            return d.amount + "m " + pct(+d.amount / 2600);
                    });


                 // .filter(function (d) { return d.x > width * .9; })
                //    .attr("class", function (d) { return d.category; })
                   // .attr("text-anchor", "end")
                   // .attr("transform", function (d) { return "translate (" + ((d.dy / 2) + 30) + "," + (d.dy / 2) + ") rotate(90)"; });

                function dragmove(d) {
                    d3.select(this)
                        .attr("transform", "translate(" + (
                               d.x = Math.max(0, Math.min(width - d.dx, d3.event.x))
                            ) + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
                    sankey.relayout();
                    link.attr("d", path);
                }
            });


        </script>

</body>
</html>

