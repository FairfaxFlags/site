<!DOCTYPE html>

<html>
<head>
    <title>Fairfax County Langage Immersion Enrollment</title>

    <!--<script src="https://d3js.org/d3.v3.min.js"></script>-->

    <script src='../../lib/d3.js' type='text/javascript'></script>

    <script src='../../lib/crossfilter.js' type='text/javascript'></script>

    <!--<script src='http://dc-js.github.io/dc.js/js/dc.js'></script>-->
    <script src='../../lib/dc.js' type='text/javascript'></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="../../lib/jquery-1.11.3.min.js"></script>
    <script src="../../lib/jquery.gridster.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/1.5.0/d3-legend.js"></script>

    <!--<link href='http://dc-js.github.io/dc.js/css/dc.css' rel='stylesheet' type='text/css'>-->
    <link href='../../css/dc.css' rel='stylesheet' type='text/css'>
    <link href="../../css/jquery.gridster.min.css" rel="stylesheet" />
</head>

<body>

    <!--<div class="dc-data-count" style="float: left;">
        <h3>Fairfax County Language Immersion Enrollment 2006 - 2015 | <span> <a href="javascript:dc.filterAll(); dc.renderAll();">Reset</a></span> </h3>
        <h4><span id="dc-chart-total"></span></h4>
    </div>-->

    <div class="gridster">
        <ul>
            <li id='dc-chart-schoolYear' data-row="1" data-col="1" data-sizex="2" data-sizey="1"><h4>School Year</h4></li>
            <li id='dc-chart-school' data-row="2" data-col="1" data-sizex="1" data-sizey="2"><h4>School</h4></li>
            <li id='dc-chart-language' data-row="2" data-col="2" data-sizex="1" data-sizey="1"><h4>Language</h4></li>
            <li id='dc-chart-gradeLevel' data-row="3" data-col="2" data-sizex="1" data-sizey="1"><h4>Grade Level</h4></li>

            <li id='dc-chart-map' data-row="1" data-col="3" data-sizex="4" data-sizey="4"><h4>Map</h4></li>
       </ul>
    </div>

    <script type="text/javascript">
    var schoolDim;
    var schoolGroup;

    queue()
        .defer(d3.json, '../../map/School_Regions_topo.json')
        .defer(d3.csv, '../../data/enrollment/enrollment.csv')
        .defer(d3.json, '../../map/dc_counties.json')
        .await(setup);


    function setup(error, regions, data, counties) {
        var svg;
        
        var regions = topojson.feature(regions, regions.objects.School_Regions);

        var gradeLevels = ["Kindergarten", "1st Grade", "2nd Grade", "3rd Grade", "4th Grade", "5th Grade", "6th Grade"]
        var records = [];
        data.forEach(function (d) {
            for (i = 0; i < 7; i++) {
                var gradeLevel = gradeLevels[i];
                if (+d[gradeLevel] != 0) {
                    records.push({
                        "school": d.school,
                        "schoolYear": +d.schoolYear,
                        "language": d.language,
                        "gradeLevel": gradeLevel,
                        "students": +d[gradeLevel]
                    });
                }
            }
        });
        
        var chartWidth = 190,
            chartHeight = 190,
            chartMargin = 5;

        var gridster;
        $(function () {
            gridster = $(".gridster ul").gridster({
                widget_base_dimensions: [chartWidth, chartHeight + 10],
                widget_margins: [chartMargin, chartMargin],
                resize: {
                    enabled: false,
                }
            }).data('gridster');
        });
        
        var languageScale = d3.scale.ordinal()
            .domain(["French", "German", "Japanese", "Spanish", "Korean"])
            .range(["rgb(153, 107, 195)", "rgb(56, 106, 197)", "rgb(93, 199, 76)", "rgb(223, 199, 31)", "rgb(234, 118, 47)"]);

        //var mapSvg =
        drawMap(regions, chartWidth, chartHeight);
        //drawMap(counties, chartWidth, chartHeight);
        drawLegend(languageScale);
        setupCharts(records, chartWidth, chartHeight);
    };

    function drawMap(counties, chartWidth, chartHeight) {
        var projection = makeProjection(counties, chartWidth * 4, chartHeight * 4);
        var path = d3.geo.path()
            .projection(projection);

        svg = d3.select("#dc-chart-map")
            .append("svg")
            .attr("width", chartWidth * 4)
            .attr("height", chartHeight * 4);

        svg.selectAll("path")
            .data(counties.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("stroke", "dimgray")
            .style("fill", function (d) {
                return "lightgrey";
            })
            .style("fill-opacity", function (d) {
                return d.value ? 0.5 : 1.0;
            });
        //return svg;
    }

    function drawLegend(languageScale) {

        svg.append("g")
               .attr("class", "legendOrdinal")
               .attr("transform", "translate(490, 50)");

        var legendOrdinal = d3.legend.color()
          //d3 symbol creates a path-string, for example
          //"M0,-8.059274488676564L9.306048591020996,
          //8.059274488676564 -9.306048591020996,8.059274488676564Z"
          .shape("path", d3.svg.symbol().type("circle").size(150)())
          .shapePadding(10)
          .scale(languageScale);

        svg.select(".legendOrdinal")
          .call(legendOrdinal);
    }

    function setupCharts(records, chartWidth, chartHeight) {
        var facts = crossfilter(records);

        //var caChart = dc.bubbleOverlay("#dc-chart-map")
        //    .svg(d3.select("#ca-chart svg"));

        // 01 group for grand total
        var totalGroup = facts.groupAll().reduce(
        function (p, v) { // add function
            return p += v.amount;
        },
        function (p, v) { // subtract function
            return p -= v.amount;
        },
        function () { return 0 } // initial function
        );
        // or you could use this convenience function:
        // var totalGroup = facts.groupAll().reduceSum(dc.pluck("amount"));

        // Display grand total
        dc.numberDisplay("#dc-chart-total")
        .group(totalGroup)
        .valueAccessor(function (d) {
            return d;
        })
        
        var schoolYearDim = facts.dimension(dc.pluck('schoolYear'));
        var schoolYearGroupSum = schoolYearDim.group().reduceSum(dc.pluck("students"));
        
        var yearBars = dc.barChart("#dc-chart-schoolYear")
            .dimension(schoolYearDim)
            .group(schoolYearGroupSum)
            .x(d3.scale.linear().domain([2006, 2015]))
            .width((chartWidth * 2) + 20)
            .height(chartHeight)
            .ordinalColors(['#9ecae1']) // light blue
            .margins({ top: 10, right: 10, bottom: 30, left: 50 })
            .gap(10)
            .centerBar(true)
            .elasticY(true)
            .brushOn(false)
            .x(d3.scale.linear().domain([2005.5, 2015.5]))

        // Doesn't return the chart, so can't chain them
        yearBars.xAxis().tickFormat(d3.format("d")); // need "2005" not "2,005"
        
        new RowChart(facts, "school", chartWidth, chartHeight, 30);
        new RowChart(facts, "language", chartWidth, chartHeight, 10);
        new RowChart(facts, "gradeLevel", chartWidth, chartHeight, 10);

        //caChart.width(chartWidth * 4)
        //    .height(chartHeight * 4)
        //    .dimension(schoolDim)
        //    .group(schoolGroup)
        //    .radiusValueAccessor(function (p) {
        //        return 10; //p.value.avgTotalCrimeRate;
        //    })
        //    .r(d3.scale.linear().domain([0, 200000]))
        //    .colors(["#ff7373", "#ff4040", "#ff0000", "#bf3030", "#a60000"])
        //    .colorDomain([13, 30])
        //    //.colorAccessor(function (p) {
        //    //    return p.value.violentCrimeRatio;
        //    //})
        //    //.title(function (d) {
        //    //    return "City: " + d.key
        //    //            + "\nTotal crime per 100k population: " + numberFormat(d.value.avgTotalCrimeRate)
        //    //            + "\nViolent crime per 100k population: " + numberFormat(d.value.avgViolentCrimeRate)
        //    //            + "\nViolent/Total crime ratio: " + numberFormat(d.value.violentCrimeRatio) + "%";
        //    //})
        //    .point("Fox Mill", 364, 400)
        //    //.point("Ottawa", 395.5, 383)
        //    //.point("Nunavut", 273, 188)
        //    .debug(false);

        dc.renderAll();
    }

    var RowChart = function (facts, attribute, width, height, maxItems) {

        var tall = +document.getElementById("dc-chart-" + attribute).getAttribute("data-sizey");
        
        // oh well..
        var chartHeight = height;
        if (tall == 2)
            chartHeight = (height * 2) + 21;

        this.dim = facts.dimension(dc.pluck(attribute));
        this.chart = dc.rowChart("#dc-chart-" + attribute)
            .dimension(this.dim)
            .group(this.dim.group().reduceSum(dc.pluck("students")))
            .data(function (d) { return d.top(maxItems); })
            .width(width)
            .height(chartHeight)
            .margins({ top: 0, right: 10, bottom: 20, left: 20 })
            .elasticX(true)
            .ordinalColors(['#9ecae1']) // light blue
            .labelOffsetX(5)
            .labelOffsetY(12)
            .xAxis().ticks(4).tickFormat(d3.format(".2s"));

        if (attribute == "school") {
            schoolDim = this.dim;
            schoolGroup = this.dim.group().reduceSum(dc.pluck("students"));
        }
    }

    // http://stackoverflow.com/questions/14492284/center-a-map-in-d3-given-a-geojson-object
    function makeProjection(features, width, height) {
        var projection = d3.geo.albers()
            .scale(1)
            .translate([0, 0]);

        // Create a path generator.
        var path = d3.geo.path()
            .projection(projection);

        // Compute the bounds of a feature of interest, then derive scale & translate.
        var scootLeft = 0;
        var b = path.bounds(features),
            s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
            t = [((width - s * (b[1][0] + b[0][0])) / 2) - scootLeft, (height - s * (b[1][1] + b[0][1])) / 2];

        // Update the projection to use computed scale & translate.
        projection
            .scale(s)
            .translate(t);

        return projection;
    }

    </script>
</body>

</html>
